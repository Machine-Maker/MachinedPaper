From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Thu, 20 May 2021 01:10:15 -0700
Subject: [PATCH] Better Stats API

== AT ==
public net.minecraft.stats.StatType map

diff --git a/src/main/java/io/papermc/paper/statistic/PaperStatistics.java b/src/main/java/io/papermc/paper/statistic/PaperStatistics.java
new file mode 100644
index 0000000000000000000000000000000000000000..e8aa7e8d08cb3a4b488de0250457499025d9f28b
--- /dev/null
+++ b/src/main/java/io/papermc/paper/statistic/PaperStatistics.java
@@ -0,0 +1,127 @@
+package io.papermc.paper.statistic;
+
+import com.google.common.base.Preconditions;
+import java.util.Objects;
+import java.util.Set;
+import net.minecraft.core.registries.BuiltInRegistries;
+import net.minecraft.resources.ResourceLocation;
+import net.minecraft.stats.ServerStatsCounter;
+import net.minecraft.stats.Stat;
+import net.minecraft.stats.StatType;
+import net.minecraft.stats.Stats;
+import net.minecraft.world.item.Item;
+import net.minecraft.world.level.block.Block;
+import org.bukkit.Material;
+import org.bukkit.NamespacedKey;
+import org.bukkit.Registry;
+import org.bukkit.craftbukkit.util.CraftMagicNumbers;
+import org.bukkit.craftbukkit.util.CraftNamespacedKey;
+import org.bukkit.entity.EntityType;
+import org.checkerframework.checker.nullness.qual.NonNull;
+import org.checkerframework.checker.nullness.qual.Nullable;
+import org.checkerframework.framework.qual.DefaultQualifier;
+
+@DefaultQualifier(NonNull.class)
+public final class PaperStatistics {
+
+    private PaperStatistics() {
+    }
+
+    public static final Set<CustomStatistic> IGNORED_STATS_FOR_EVENT = Set.of(
+        CustomStatistic.FALL_ONE_CM,
+        CustomStatistic.BOAT_ONE_CM,
+        CustomStatistic.CLIMB_ONE_CM,
+        CustomStatistic.WALK_ON_WATER_ONE_CM,
+        CustomStatistic.WALK_UNDER_WATER_ONE_CM,
+        CustomStatistic.FLY_ONE_CM,
+        CustomStatistic.HORSE_ONE_CM,
+        CustomStatistic.MINECART_ONE_CM,
+        CustomStatistic.PIG_ONE_CM,
+        CustomStatistic.PLAY_TIME,
+        CustomStatistic.SWIM_ONE_CM,
+        CustomStatistic.WALK_ONE_CM,
+        CustomStatistic.SPRINT_ONE_CM,
+        CustomStatistic.CROUCH_ONE_CM,
+        CustomStatistic.TIME_SINCE_DEATH,
+        CustomStatistic.SNEAK_TIME,
+        CustomStatistic.TOTAL_WORLD_TIME,
+        CustomStatistic.TIME_SINCE_REST,
+        CustomStatistic.AVIATE_ONE_CM,
+        CustomStatistic.STRIDER_ONE_CM
+    );
+
+    public static CustomStatistic minecraftToPaper(final NamespacedKey key, final ResourceLocation ignored) {
+        return Objects.requireNonNull(CustomStatistic.CUSTOM_STATISTIC_MAP.get(key));
+    }
+
+    public static StatisticType<?> minecraftToPaper(final NamespacedKey key, final StatType<?> ignored) {
+        return Objects.requireNonNull(StatisticType.STATISTIC_TYPE_MAP.get(key));
+    }
+
+
+    public static void changeStatistic(ServerStatsCounter manager, Statistic<?> statistic, int delta) {
+        if (delta == 0) return;
+        Preconditions.checkNotNull(statistic, "statistic cannot be null");
+        final Stat<?> stat = getNMSStatistic(statistic);
+        //noinspection ConstantConditions
+        manager.setValue(null, stat, manager.getValue(stat) + delta);
+    }
+
+    public static void setStatistic(ServerStatsCounter manager, Statistic<?> statistic, int newAmount) {
+        Preconditions.checkNotNull(statistic, "Statistic cannot be null");
+        Preconditions.checkArgument(newAmount >= 0, "New amount must be greater than or equal to 0");
+        //noinspection ConstantConditions
+        manager.setValue(null, getNMSStatistic(statistic), newAmount);
+    }
+
+    public static int getStatistic(ServerStatsCounter manager, Statistic<?> statistic) {
+        Preconditions.checkNotNull(statistic, "Statistic cannot be null");
+        return manager.getValue(getNMSStatistic(statistic));
+    }
+
+    public static String getFormattedValue(ServerStatsCounter manager, Statistic<?> statistic) {
+        final Stat<?> nmsStat = getNMSStatistic(statistic);
+        return nmsStat.format(manager.getValue(nmsStat));
+    }
+
+    @SuppressWarnings("unchecked")
+    public static Statistic<?> getPaperStatistic(Stat<?> nmsStat) {
+        final ResourceLocation statTypeKey = Preconditions.checkNotNull(BuiltInRegistries.STAT_TYPE.getKey(nmsStat.getType()), "Could not get the stat type resource location from " + nmsStat);
+        final @Nullable StatisticType<?> type = Registry.STATISTIC_TYPE.get(CraftNamespacedKey.fromMinecraft(statTypeKey));
+        final Statistic<?> paperStat;
+        if (type == StatisticType.BLOCK_MINED) {
+            paperStat = StatisticType.BLOCK_MINED.of(CraftMagicNumbers.getMaterial((Block) nmsStat.getValue()));
+        } else if (type == StatisticType.ITEM_CRAFTED || type == StatisticType.ITEM_USED || type == StatisticType.ITEM_BROKEN || type == StatisticType.ITEM_PICKED_UP || type == StatisticType.ITEM_DROPPED) {
+            paperStat = ((StatisticType<Material>) type).of(CraftMagicNumbers.getMaterial((Item) nmsStat.getValue()));
+        } else if (type == StatisticType.ENTITY_KILLED) {
+            paperStat = StatisticType.ENTITY_KILLED.of(CraftMagicNumbers.getEntityType((net.minecraft.world.entity.EntityType<?>) nmsStat.getValue()));
+        } else if (type == StatisticType.ENTITY_KILLED_BY) {
+            paperStat = StatisticType.ENTITY_KILLED_BY.of(CraftMagicNumbers.getEntityType((net.minecraft.world.entity.EntityType<?>) nmsStat.getValue()));
+        } else if (type == StatisticType.CUSTOM_STATS) {
+            paperStat = StatisticType.CUSTOM_STATS.of(Objects.requireNonNull(Registry.CUSTOM_STATISTIC.get(CraftNamespacedKey.fromMinecraft((ResourceLocation) nmsStat.getValue()))));
+        } else {
+            throw new IllegalArgumentException("Did not recognize " + type + " as a statistic type");
+        }
+        return Objects.requireNonNull(paperStat, "Couldn't convert " + nmsStat + " to a stat of type " + type);
+    }
+
+    @SuppressWarnings("unchecked")
+    public static Stat<?> getNMSStatistic(Statistic<?> paperStat) {
+        final StatType<?> type = Preconditions.checkNotNull(BuiltInRegistries.STAT_TYPE.get(CraftNamespacedKey.toMinecraft(paperStat.type().getKey())), paperStat + " could not be converted to a nms StatType");
+        final Stat<?> nmsStat;
+        if (type == Stats.BLOCK_MINED) {
+            nmsStat = Stats.BLOCK_MINED.get(CraftMagicNumbers.getBlock((Material) paperStat.value()));
+        } else if (type == Stats.ITEM_CRAFTED || type == Stats.ITEM_USED || type == Stats.ITEM_BROKEN || type == Stats.ITEM_PICKED_UP || type == Stats.ITEM_DROPPED) {
+            nmsStat = ((StatType<Item>) type).get(CraftMagicNumbers.getItem((Material) paperStat.value()));
+        } else if (type == Stats.ENTITY_KILLED) {
+            nmsStat = Stats.ENTITY_KILLED.get(CraftMagicNumbers.getEntityTypes((EntityType) paperStat.value()));
+        } else if (type == Stats.ENTITY_KILLED_BY) {
+            nmsStat = Stats.ENTITY_KILLED_BY.get(CraftMagicNumbers.getEntityTypes((EntityType) paperStat.value()));
+        } else if (type == Stats.CUSTOM) {
+            nmsStat = Stats.CUSTOM.map.get(BuiltInRegistries.CUSTOM_STAT.get(CraftNamespacedKey.toMinecraft(((CustomStatistic) paperStat.value()).getKey())));
+        } else {
+            throw new IllegalArgumentException("Did not recognize " + BuiltInRegistries.STAT_TYPE.getKey(type) + " as a statistic type");
+        }
+        return Objects.requireNonNull(nmsStat, "Couldn't convert " + paperStat + " into a nms stat");
+    }
+}
diff --git a/src/main/java/net/minecraft/stats/ServerStatsCounter.java b/src/main/java/net/minecraft/stats/ServerStatsCounter.java
index 9501e5f25f5c4d3069e554d4dc82b0e094156682..67a719de205f0eed13ef200fe45da4b5410b0337 100644
--- a/src/main/java/net/minecraft/stats/ServerStatsCounter.java
+++ b/src/main/java/net/minecraft/stats/ServerStatsCounter.java
@@ -244,6 +244,20 @@ public class ServerStatsCounter extends StatsCounter {
 
             object2intmap.put(statistic, this.getValue(statistic));
         }
+        // Paper start
+        if (io.papermc.paper.event.player.PlayerRequestStatisticsEvent.getHandlerList().getRegisteredListeners().length > 0) {
+            io.papermc.paper.event.player.PlayerRequestStatisticsEvent statEvent = new io.papermc.paper.event.player.PlayerRequestStatisticsEvent(
+                player.getBukkitEntity(),
+                object2intmap.object2IntEntrySet()
+                    .stream()
+                    .collect(Object2IntOpenHashMap::new, (map, entry) -> map.put(io.papermc.paper.statistic.PaperStatistics.getPaperStatistic(entry.getKey()), entry.getIntValue()), Object2IntOpenHashMap::putAll)
+            );
+            if (!statEvent.callEvent()) {
+                return;
+            }
+            object2intmap = statEvent.getStatisticMap().object2IntEntrySet().stream().collect(Object2IntOpenHashMap::new, (map, entry) -> map.put(io.papermc.paper.statistic.PaperStatistics.getNMSStatistic(entry.getKey()), entry.getIntValue()), Object2IntOpenHashMap::putAll);
+        }
+        // Paper end
 
         player.connection.send(new ClientboundAwardStatsPacket(object2intmap));
     }
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java b/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java
index c6129dc565b8f874b73e2fefcabd4be1c221fd73..cbbffefbd88fe84cdaab1e8012f8d0318aa2a71b 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java
@@ -369,6 +369,48 @@ public class CraftOfflinePlayer implements OfflinePlayer, ConfigurationSerializa
         return this.server.getHandle().getPlayerStats(this.getUniqueId(), this.getName());
     }
 
+    // Paper start
+    @Override
+    public void incrementStatistic(io.papermc.paper.statistic.Statistic<?> statistic, int amount) {
+        if (this.isOnline()) {
+            this.getPlayer().incrementStatistic(statistic, amount);
+        } else {
+            ServerStatsCounter manager = getStatisticManager();
+            io.papermc.paper.statistic.PaperStatistics.changeStatistic(manager, statistic, amount);
+            manager.save();
+        }
+
+    }
+
+    @Override
+    public void setStatistic(io.papermc.paper.statistic.Statistic<?> statistic, int newAmount) {
+        if (this.isOnline()) {
+            this.getPlayer().setStatistic(statistic, newAmount);
+        } else {
+            ServerStatsCounter manager = getStatisticManager();
+            io.papermc.paper.statistic.PaperStatistics.setStatistic(manager, statistic, newAmount);
+            manager.save();
+        }
+    }
+
+    @Override
+    public int getStatistic(io.papermc.paper.statistic.Statistic<?> statistic) {
+        if (isOnline()) {
+            return this.getPlayer().getStatistic(statistic);
+        } else {
+            return io.papermc.paper.statistic.PaperStatistics.getStatistic(getStatisticManager(), statistic);
+        }
+    }
+
+    @Override
+    public String getFormattedValue(io.papermc.paper.statistic.Statistic<?> statistic) {
+        if (this.isOnline()) {
+            return this.getPlayer().getFormattedValue(statistic);
+        } else {
+            return io.papermc.paper.statistic.PaperStatistics.getFormattedValue(getStatisticManager(), statistic);
+        }
+    }
+    // Paper end
     @Override
     public void incrementStatistic(Statistic statistic) {
         if (this.isOnline()) {
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftRegistry.java b/src/main/java/org/bukkit/craftbukkit/CraftRegistry.java
index 15abd319ac51a97cdb07da85e815ea93ff45431a..d6f9ad385dd62c2ed809abfef91cdab3393dfb84 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftRegistry.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftRegistry.java
@@ -43,6 +43,15 @@ public class CraftRegistry<B extends Keyed, M> implements Registry<B> {
         }
         // Paper end
 
+        // Paper start - better stats API
+        if (bukkitClass == io.papermc.paper.statistic.CustomStatistic.class) {
+            return new CraftRegistry<>(BuiltInRegistries.CUSTOM_STAT, io.papermc.paper.statistic.PaperStatistics::minecraftToPaper);
+        }
+        if (bukkitClass == io.papermc.paper.statistic.StatisticType.class) {
+            return new CraftRegistry<>(BuiltInRegistries.STAT_TYPE, io.papermc.paper.statistic.PaperStatistics::minecraftToPaper);
+        }
+        // Paper end - better stats API
+
         return null;
     }
 
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftStatistic.java b/src/main/java/org/bukkit/craftbukkit/CraftStatistic.java
index b757ace5ee5b8c0856ab8d304725f45763d2183e..6165b7f5680534e464756f1d12a9ef2ad6aeb58f 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftStatistic.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftStatistic.java
@@ -16,6 +16,7 @@ import org.bukkit.Statistic.Type;
 import org.bukkit.craftbukkit.util.CraftMagicNumbers;
 import org.bukkit.entity.EntityType;
 
+@Deprecated(forRemoval = true) // Paper
 public enum CraftStatistic {
     DAMAGE_DEALT(Stats.DAMAGE_DEALT),
     DAMAGE_TAKEN(Stats.DAMAGE_TAKEN),
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index c9e4a2635c421df192f62c0903659347bce677f9..da265b66cd74a18adf39ee34f5e39964cd9f1623 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1486,6 +1486,27 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         return bukkitRecipeKeys.build();
     }
 
+    // Paper start
+    @Override
+    public void incrementStatistic(io.papermc.paper.statistic.Statistic<?> statistic, int amount) {
+        io.papermc.paper.statistic.PaperStatistics.changeStatistic(this.getHandle().getStats(), statistic, amount);
+    }
+
+    @Override
+    public void setStatistic(io.papermc.paper.statistic.Statistic<?> statistic, int newAmount) {
+        io.papermc.paper.statistic.PaperStatistics.setStatistic(this.getHandle().getStats(), statistic, newAmount);
+    }
+
+    @Override
+    public int getStatistic(io.papermc.paper.statistic.Statistic<?> statistic) {
+        return io.papermc.paper.statistic.PaperStatistics.getStatistic(this.getHandle().getStats(), statistic);
+    }
+
+    @Override
+    public String getFormattedValue(io.papermc.paper.statistic.Statistic<?> statistic) {
+        return io.papermc.paper.statistic.PaperStatistics.getFormattedValue(this.getHandle().getStats(), statistic);
+    }
+    // Paper end
     @Override
     public void incrementStatistic(Statistic statistic) {
         CraftStatistic.incrementStatistic(this.getHandle().getStats(), statistic);
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 26e1a9002d675245d4cf91e6682605314b078fb2..fa8cf2aa5a003b5cd3862069f017fa0779cbc1a1 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -1668,45 +1668,14 @@ public class CraftEventFactory {
         Player player = ((ServerPlayer) entityHuman).getBukkitEntity();
         Event event;
         if (true) {
-            org.bukkit.Statistic stat = CraftStatistic.getBukkitStatistic(statistic);
-            if (stat == null) {
-                System.err.println("Unhandled statistic: " + statistic);
-                return null;
-            }
-            switch (stat) {
-                case FALL_ONE_CM:
-                case BOAT_ONE_CM:
-                case CLIMB_ONE_CM:
-                case WALK_ON_WATER_ONE_CM:
-                case WALK_UNDER_WATER_ONE_CM:
-                case FLY_ONE_CM:
-                case HORSE_ONE_CM:
-                case MINECART_ONE_CM:
-                case PIG_ONE_CM:
-                case PLAY_ONE_MINUTE:
-                case SWIM_ONE_CM:
-                case WALK_ONE_CM:
-                case SPRINT_ONE_CM:
-                case CROUCH_ONE_CM:
-                case TIME_SINCE_DEATH:
-                case SNEAK_TIME:
-                case TOTAL_WORLD_TIME:
-                case TIME_SINCE_REST:
-                case AVIATE_ONE_CM:
-                case STRIDER_ONE_CM:
+            // Paper start - better stats api
+            io.papermc.paper.statistic.Statistic<?> stat = io.papermc.paper.statistic.PaperStatistics.getPaperStatistic(statistic);
+            if (stat.value() instanceof io.papermc.paper.statistic.CustomStatistic customStatistic && io.papermc.paper.statistic.PaperStatistics.IGNORED_STATS_FOR_EVENT.contains(customStatistic)) {
                     // Do not process event for these - too spammy
                     return null;
-                default:
-            }
-            if (stat.getType() == Type.UNTYPED) {
-                event = new PlayerStatisticIncrementEvent(player, stat, current, newValue);
-            } else if (stat.getType() == Type.ENTITY) {
-                EntityType entityType = CraftStatistic.getEntityTypeFromStatistic((net.minecraft.stats.Stat<net.minecraft.world.entity.EntityType<?>>) statistic);
-                event = new PlayerStatisticIncrementEvent(player, stat, current, newValue, entityType);
-            } else {
-                Material material = CraftStatistic.getMaterialFromStatistic(statistic);
-                event = new PlayerStatisticIncrementEvent(player, stat, current, newValue, material);
             }
+            event = new PlayerStatisticIncrementEvent(player, stat, current, newValue);
+            // Paper end - better stats api
         }
         entityHuman.level().getCraftServer().getPluginManager().callEvent(event);
         return (Cancellable) event;
diff --git a/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftCriteria.java b/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftCriteria.java
index d849ef9a51dc901c8045d63218b8ee5fa5c7ee7a..a76df0339a3b83dff01de38fe316d5458f588be8 100644
--- a/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftCriteria.java
+++ b/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftCriteria.java
@@ -8,21 +8,21 @@ import org.bukkit.scoreboard.Criteria;
 import org.bukkit.scoreboard.RenderType;
 
 public final class CraftCriteria implements Criteria {
-    static final Map<String, CraftCriteria> DEFAULTS;
+    static final Map<String, Criteria> DEFAULTS; // Paper - stats api
     static final CraftCriteria DUMMY;
 
     static {
-        ImmutableMap.Builder<String, CraftCriteria> defaults = ImmutableMap.builder();
+        ImmutableMap.Builder<String, Criteria> defaults = ImmutableMap.builder(); // Paper - stats api
 
         for (Map.Entry<String, ObjectiveCriteria> entry : ObjectiveCriteria.CRITERIA_CACHE.entrySet()) {
             String name = entry.getKey();
             ObjectiveCriteria criteria = entry.getValue();
 
-            defaults.put(name, new CraftCriteria(criteria));
+            defaults.put(name, convertFromNms(criteria)); // Paper - stats api
         }
 
         DEFAULTS = defaults.build();
-        DUMMY = DEFAULTS.get("dummy");
+        DUMMY = (CraftCriteria) DEFAULTS.get("dummy"); // Paper - stats api
     }
 
     final ObjectiveCriteria criteria;
@@ -53,17 +53,23 @@ public final class CraftCriteria implements Criteria {
         return RenderType.values()[this.criteria.getDefaultRenderType().ordinal()];
     }
 
-    static CraftCriteria getFromNMS(Objective objective) {
-        return java.util.Objects.requireNonNullElseGet(CraftCriteria.DEFAULTS.get(objective.getCriteria().getName()), () -> new CraftCriteria(objective.getCriteria())); // Paper
+    static Criteria getFromNMS(Objective objective) { // Paper - stats api
+        return java.util.Objects.requireNonNullElseGet(CraftCriteria.DEFAULTS.get(objective.getCriteria().getName()), () -> convertFromNms(objective.getCriteria())); // Paper
     }
 
-    public static CraftCriteria getFromBukkit(String name) {
-        CraftCriteria criteria = CraftCriteria.DEFAULTS.get(name);
+    // Paper start - stats api
+    static Criteria convertFromNms(ObjectiveCriteria criteria) {
+        return criteria instanceof net.minecraft.stats.Stat<?> stat ? io.papermc.paper.statistic.PaperStatistics.getPaperStatistic(stat) : new CraftCriteria(criteria);
+    }
+    // Paper end
+
+    public static Criteria getFromBukkit(String name) { // Paper - stats api
+        Criteria criteria = CraftCriteria.DEFAULTS.get(name); // Paper - stats api
         if (criteria != null) {
             return criteria;
         }
 
-        return ObjectiveCriteria.byName(name).map(CraftCriteria::new).orElseGet(() -> new CraftCriteria(name));
+        return ObjectiveCriteria.byName(name).map(CraftCriteria::convertFromNms).orElseGet(() -> new CraftCriteria(name)); // Paper - stats api
     }
 
     @Override
diff --git a/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftObjective.java b/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftObjective.java
index 442ed17a4c91fe5ccf567f2af518569b945aa36c..3f4218440e6857e75371451e1583ffb1541bff6a 100644
--- a/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftObjective.java
+++ b/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftObjective.java
@@ -12,7 +12,7 @@ import org.bukkit.scoreboard.Score;
 
 final class CraftObjective extends CraftScoreboardComponent implements Objective {
     private final net.minecraft.world.scores.Objective objective;
-    private final CraftCriteria criteria;
+    private final Criteria criteria; // Paper - stats api
 
     CraftObjective(CraftScoreboard scoreboard, net.minecraft.world.scores.Objective objective) {
         super(scoreboard);
@@ -65,7 +65,7 @@ final class CraftObjective extends CraftScoreboardComponent implements Objective
     public String getCriteria() {
         this.checkState();
 
-        return criteria.bukkitName;
+        return criteria.getName(); // Paper - stats api
     }
 
     @Override
@@ -79,7 +79,7 @@ final class CraftObjective extends CraftScoreboardComponent implements Objective
     public boolean isModifiable() {
         this.checkState();
 
-        return !criteria.criteria.isReadOnly();
+        return !criteria.isReadOnly(); // Paper - stats api
     }
 
     @Override
diff --git a/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftScoreboard.java b/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftScoreboard.java
index a8c5bfc54ed2b8bd873f124c7080d73fe73a86ad..60a408e5b84348506a9b3d62dc721f5391f2d1ca 100644
--- a/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftScoreboard.java
+++ b/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftScoreboard.java
@@ -52,12 +52,15 @@ public final class CraftScoreboard implements org.bukkit.scoreboard.Scoreboard {
         Preconditions.checkArgument(name.length() <= Short.MAX_VALUE, "The name '%s' is longer than the limit of 32767 characters (%s)", name, name.length());
         Preconditions.checkArgument(this.board.getObjective(name) == null, "An objective of name '%s' already exists", name);
         // Paper start - lazily track plugin scoreboards
-        if (((CraftCriteria) criteria).criteria != net.minecraft.world.scores.criteria.ObjectiveCriteria.DUMMY && !this.registeredGlobally) {
+        // Paper start - stats API
+        java.util.Optional<net.minecraft.world.scores.criteria.ObjectiveCriteria> nmsCriteria = net.minecraft.world.scores.criteria.ObjectiveCriteria.byName(criteria.getName());
+        if (nmsCriteria.isPresent() && nmsCriteria.get() != net.minecraft.world.scores.criteria.ObjectiveCriteria.DUMMY && !this.registeredGlobally) {
+            // Paper end - stats API
             net.minecraft.server.MinecraftServer.getServer().server.getScoreboardManager().registerScoreboardForVanilla(this);
             this.registeredGlobally = true;
         }
         // Paper end
-        net.minecraft.world.scores.Objective objective = this.board.addObjective(name, ((CraftCriteria) criteria).criteria, io.papermc.paper.adventure.PaperAdventure.asVanilla(displayName), CraftScoreboardTranslations.fromBukkitRender(renderType));
+        net.minecraft.world.scores.Objective objective = this.board.addObjective(name, nmsCriteria.orElse(net.minecraft.world.scores.criteria.ObjectiveCriteria.DUMMY), io.papermc.paper.adventure.PaperAdventure.asVanilla(displayName), CraftScoreboardTranslations.fromBukkitRender(renderType)); // Paper - stats API
         return new CraftObjective(this, objective);
     }
     // Paper end - Adventure
diff --git a/src/test/java/io/papermc/paper/statistic/PaperStatsTest.java b/src/test/java/io/papermc/paper/statistic/PaperStatsTest.java
new file mode 100644
index 0000000000000000000000000000000000000000..90fb033f348aae9690595d496f22d526a27e0430
--- /dev/null
+++ b/src/test/java/io/papermc/paper/statistic/PaperStatsTest.java
@@ -0,0 +1,62 @@
+package io.papermc.paper.statistic;
+
+import java.util.HashSet;
+import java.util.Locale;
+import java.util.Set;
+import net.minecraft.core.registries.BuiltInRegistries;
+import net.minecraft.resources.ResourceLocation;
+import net.minecraft.stats.StatType;
+import org.bukkit.Material;
+import org.bukkit.Registry;
+import org.bukkit.craftbukkit.util.CraftNamespacedKey;
+import org.bukkit.support.AbstractTestingBase;
+import org.junit.Test;
+
+import static org.junit.Assert.assertEquals;
+import static org.junit.Assert.assertNotNull;
+import static org.junit.Assert.assertThrows;
+
+public class PaperStatsTest extends AbstractTestingBase {
+
+    @Test
+    public void testNMSCustomStatToPaperCustomStat() {
+        Set<ResourceLocation> missingKeys = new HashSet<>();
+        for (ResourceLocation minecraftKey : BuiltInRegistries.CUSTOM_STAT) {
+            if (Registry.CUSTOM_STATISTIC.get(CraftNamespacedKey.fromMinecraft(minecraftKey)) == null) {
+                missingKeys.add(minecraftKey);
+            }
+        }
+        StringBuilder sb = new StringBuilder("\n");
+        for (ResourceLocation missingKey : missingKeys) {
+            sb.append("public static final CustomStatistic ").append(missingKey.getPath().toUpperCase(Locale.ENGLISH)).append(" = create(\"").append(missingKey.getPath()).append("\");\n");
+        }
+        if (!missingKeys.isEmpty()) {
+            System.out.println(sb);
+        }
+        assertEquals("Some stats are missing paper counterparts: " + missingKeys, 0, missingKeys.size());
+    }
+
+    @Test
+    public void testPaperCustomStatToNMSCustomStat() {
+        Set<CustomStatistic> extraStats = new HashSet<>();
+        for (CustomStatistic paperCustomStat : Registry.CUSTOM_STATISTIC) {
+            ResourceLocation stat = BuiltInRegistries.CUSTOM_STAT.get(CraftNamespacedKey.toMinecraft(paperCustomStat.getKey()));
+            if (stat == null) {
+                extraStats.add(paperCustomStat);
+            }
+        }
+        assertEquals("These stats do not have NMS counterparts: " + extraStats, 0, extraStats.size());
+    }
+
+    @Test
+    public void checkAllStatTypes() {
+        for (StatType<?> stat : BuiltInRegistries.STAT_TYPE) {
+            assertNotNull(BuiltInRegistries.STAT_TYPE.getKey(stat) + " is missing its paper counterpart", Registry.STATISTIC_TYPE.get(CraftNamespacedKey.fromMinecraft(BuiltInRegistries.STAT_TYPE.getResourceKey(stat).orElseThrow().location())));
+        }
+    }
+
+    @Test
+    public void testInvalidStat() {
+        assertThrows("created a block mined stat for a pickaxe", IllegalArgumentException.class, () -> StatisticType.BLOCK_MINED.of(Material.DIAMOND_PICKAXE));
+    }
+}
diff --git a/src/test/java/io/papermc/paper/world/TranslationKeyTest.java b/src/test/java/io/papermc/paper/world/TranslationKeyTest.java
index ffc9776a8927d6255820d1384c9e66f99a7b692c..fe0d76b774e4ffed07e4888c8f4455e453b0bbcb 100644
--- a/src/test/java/io/papermc/paper/world/TranslationKeyTest.java
+++ b/src/test/java/io/papermc/paper/world/TranslationKeyTest.java
@@ -1,6 +1,7 @@
 package io.papermc.paper.world;
 
 import com.destroystokyo.paper.ClientOption;
+import io.papermc.paper.statistic.StatisticType;
 import java.util.Map;
 import net.minecraft.core.registries.BuiltInRegistries;
 import net.minecraft.network.chat.contents.TranslatableContents;
@@ -59,6 +60,14 @@ public class TranslationKeyTest extends AbstractTestingBase {
         }
     }
 
+    @Test
+    public void testStatType() {
+        for (StatisticType<?> statisticType : org.bukkit.Registry.STATISTIC_TYPE) {
+            if (statisticType == StatisticType.CUSTOM_STATS) continue;
+            Assert.assertEquals("translation key mismatch for " + statisticType, BuiltInRegistries.STAT_TYPE.getOptional(CraftNamespacedKey.toMinecraft(statisticType.getKey())).orElseThrow().getTranslationKey(), statisticType.translationKey());
+        }
+    }
+
     @Test
     @Ignore // TODO fix
     public void testCreativeCategory() {
diff --git a/src/test/java/org/bukkit/StatisticsAndAchievementsTest.java b/src/test/java/org/bukkit/StatisticsAndAchievementsTest.java
index c00bceb80232686169fcd15dd004ed41124bd78a..caa373504f459dbdf6eea13ef64b460636482630 100644
--- a/src/test/java/org/bukkit/StatisticsAndAchievementsTest.java
+++ b/src/test/java/org/bukkit/StatisticsAndAchievementsTest.java
@@ -10,6 +10,7 @@ import org.bukkit.entity.EntityType;
 import org.bukkit.support.AbstractTestingBase;
 import org.junit.Test;
 
+@Deprecated(forRemoval = true) // Paper
 public class StatisticsAndAchievementsTest extends AbstractTestingBase {
 
     @Test
